#!/usr/bin/env python3
"""
ros2px4: tiny CLI to scaffold a ROS 2 Python package from your template.

Usage:
  ros2px4 pkg create --name <PACKAGE> [--node-name <NODE>] [--template src/template_pkg] [--dest-root src] [--dry-run] [--force]
"""
import argparse, re, shutil, stat, sys
from pathlib import Path

TARGET_EXTS = {
    ".py", ".xml", ".cfg", ".ini", ".toml", ".yaml", ".yml",
    ".txt", ".launch.py", ".md", ".rst", ""
}

def log(msg): print(f"[ros2px4] {msg}")

def copy_tree(src: Path, dst: Path, dry=False):
    if not src.exists():
        sys.exit(f"Template not found: {src}")
    if dst.exists():
        sys.exit(f"Destination exists: {dst}")
    log(f"Copy {src} -> {dst}")
    if not dry:
        shutil.copytree(src, dst)

def strip_git_dirs(root: Path, dry=False):
    for p in root.rglob(".git"):
        if p.is_dir():
            log(f"Remove git dir: {p}")
            if not dry:
                shutil.rmtree(p, ignore_errors=True)

def safe_rename(old: Path, new: Path, dry=False):
    if not old.exists(): 
        return
    if new.exists():
        sys.exit(f"Cannot rename {old} -> {new} (dest exists)")
    log(f"Rename {old} -> {new}")
    if not dry:
        old.rename(new)

def replace_in_file(path: Path, replacements, dry=False):
    try:
        text = path.read_text(encoding="utf-8", errors="ignore")
    except Exception:
        return
    orig = text
    for pat, repl, is_regex in replacements:
        text = re.sub(pat, repl, text) if is_regex else text.replace(pat, repl)
    if text != orig:
        log(f"Edit {path}")
        if not dry:
            path.write_text(text, encoding="utf-8")

def make_scripts_executable(pkg_dir: Path, dry=False):
    sd = pkg_dir / "scripts"
    if sd.exists():
        for f in sd.iterdir():
            if f.is_file() and f.suffix == ".py":
                if not dry:
                    f.chmod(f.stat().st_mode | stat.S_IXUSR | stat.S_IXGRP | stat.S_IXOTH)
                log(f"chmod +x {f}")

def build_replacements(old_pkg: str, new_pkg: str, new_node: str):
    # Specific → general; keep raw name replace last
    simple = [
        ("'"+old_pkg+"_node'", f"'{new_node}'"),
        ('"'+old_pkg+'_node"', f'"{new_node}"'),
        (f"{old_pkg} = {old_pkg}", f"{new_pkg} = {new_pkg}"),   # common console-scripts line
        (old_pkg, new_pkg),  # fallback last
    ]
    regex = [
        # package.xml
        (rf"(<name>\s*){re.escape(old_pkg)}(\s*</name>)", r"\1" + new_pkg + r"\2"),
        # setup.cfg / setup.py entry_points
        (rf'(?m)^\s*{re.escape(old_pkg)}\s*=\s*{re.escape(old_pkg)}(\.[\w:]+)', new_pkg + r'\1'),
        (rf'(?m){re.escape(old_pkg)}\s*=\s*{re.escape(old_pkg)}(\.[\w:]+)',
         new_pkg + r'=' + new_pkg + r'\1'),
        # imports
        (rf"\bfrom\s+{re.escape(old_pkg)}\b", "from " + new_pkg),
        (rf"\bimport\s+{re.escape(old_pkg)}\b", "import " + new_pkg),
        # Node name fallback
        (rf"super\(\)\.__init__\(\s*['\"]{re.escape(old_pkg)}_node['\"]\s*\)",
         f"super().__init__('{new_node}')"),
        # pyproject optional: name = "old_pkg"
        (rf'(?m)^(name\s*=\s*")[^"]+(")', r'\1' + new_pkg + r'\2'),
        # [project.scripts] old = "old.main:main" → new = "new.main:main"
        (rf'(?m)^\s*{re.escape(old_pkg)}\s*=\s*"[^\"]*"', f'{new_pkg} = "{new_pkg}.main:main"'),
    ]
    return [(a,b,False) for a,b in simple] + [(a,b,True) for a,b in regex]

def do_pkg_create(args):
    new_pkg = args.name
    new_node = args.node_name or (new_pkg + "_node")
    template_dir = Path(args.template).resolve()
    dest_root = Path(args.dest_root).resolve()
    pkg_dir = dest_root / new_pkg

    if args.force and pkg_dir.exists():
        log(f"--force: removing existing {pkg_dir}")
        shutil.rmtree(pkg_dir)

    old_pkg = template_dir.name  # typically 'template_pkg'

    copy_tree(template_dir, pkg_dir, dry=args.dry_run)
    strip_git_dirs(pkg_dir, dry=args.dry_run)

    # Rename inner python package dir and resource file
    safe_rename(pkg_dir / old_pkg, pkg_dir / new_pkg, dry=args.dry_run)
    safe_rename(pkg_dir / "resource" / old_pkg, pkg_dir / "resource" / new_pkg, dry=args.dry_run)

    # Apply text replacements
    repls = build_replacements(old_pkg, new_pkg, new_node)
    for p in pkg_dir.rglob("*"):
        if p.is_file() and (p.suffix in TARGET_EXTS or p.name.endswith(".launch.py")):
            replace_in_file(p, repls, dry=args.dry_run)

    make_scripts_executable(pkg_dir, dry=args.dry_run)

    if args.dry_run:
        log("Dry-run complete.")
    else:
        log(f"Created package: {pkg_dir}")
        print("\nNext steps:\n  rosdep update && rosdep install --from-paths src --ignore-src -y\n  colcon build\n  source install/setup.bash")

def main():
    p = argparse.ArgumentParser(prog="ros2px4", description="Helper CLI for ROS2/PX4 template workspaces")
    sub = p.add_subparsers(dest="cmd", required=True)

    # ros2px4 pkg create ...
    p_pkg = sub.add_parser("pkg", help="Package-related commands")
    sub_pkg = p_pkg.add_subparsers(dest="pkg_cmd", required=True)

    p_create = sub_pkg.add_parser("create", help="Create a package from your template")
    p_create.add_argument("--name", required=True, help="New package name (directory + ROS package name)")
    p_create.add_argument("--node-name", help="Node name for super().__init__('...') (default: <name>_node)")
    p_create.add_argument("--template", default="src/template_pkg",
                          help="Path to template package (default: src/template_pkg)")
    p_create.add_argument("--dest-root", default="src", help="Where to create the new package (default: src)")
    p_create.add_argument("--dry-run", action="store_true", help="Preview changes without writing files")
    p_create.add_argument("--force", action="store_true", help="Overwrite existing target directory")
    p_create.set_defaults(func=do_pkg_create)

    args = p.parse_args()
    args.func(args)

if __name__ == "__main__":
    main()
